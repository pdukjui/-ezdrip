<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Smart Drip Ultimate</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Typography & Base --- */
        body { 
            font-family: 'Prompt', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background-color: #FAFAFA;
        }
        .font-mono { font-family: 'Space Mono', monospace; }
        
        /* --- Layout Helper --- */
        .h-dvh { height: 100dvh; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Custom UI Components --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        
        .coffee-gradient {
            background: linear-gradient(135deg, #2C2C2C 0%, #4A4A4A 100%);
            color: white;
        }

        .btn-primary {
            background: #1F2937;
            color: white;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.96); }

        /* --- Range Slider Styling --- */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #1F2937;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 2px;
        }

        /* --- Animations --- */
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(31, 41, 55, 0.2); }
            70% { box-shadow: 0 0 0 10px rgba(31, 41, 55, 0); }
            100% { box-shadow: 0 0 0 0 rgba(31, 41, 55, 0); }
        }
        .brewing-pulse {
            animation: pulse-ring 2s infinite;
        }
        
        .step-transition {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="text-slate-800 h-dvh overflow-hidden flex flex-col selection:bg-stone-200">

    <!-- HEADER -->
    <header class="flex-none px-5 py-4 bg-white/90 backdrop-blur z-20 flex items-center justify-between border-b border-slate-100">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white shadow-lg shadow-slate-200">
                <i class="fa-solid fa-mug-hot text-lg"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold leading-none tracking-tight">Drip Master</h1>
                <span class="text-[10px] text-slate-400 font-medium tracking-wide uppercase">Professional Assistant</span>
            </div>
        </div>
        <button onclick="resetApp()" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 flex items-center justify-center transition">
            <i class="fa-solid fa-arrow-rotate-right"></i>
        </button>
    </header>

    <!-- SETUP SCREEN -->
    <main id="setup-screen" class="flex-1 overflow-y-auto w-full max-w-lg mx-auto p-5 pb-36 space-y-6">
        
        <!-- 1. Equipment Selector -->
        <section>
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Equipment</h2>
                <div id="grind-badge" class="text-[10px] font-medium bg-blue-50 text-blue-600 px-2 py-1 rounded-md transition-all">
                    แนะนำ: บดปานกลาง
                </div>
            </div>
            <div class="grid grid-cols-4 gap-3">
                <!-- Generated by JS -->
            </div>
        </section>

        <!-- 2. Coffee & Ratio Calculator -->
        <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
            <!-- Coffee Input -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-4">
                    <button onclick="adjustCoffee(-1)" class="w-8 h-8 rounded-full border border-slate-200 text-slate-400 flex items-center justify-center active:bg-slate-50">
                        <i class="fa-solid fa-minus text-xs"></i>
                    </button>
                    <div class="text-center">
                        <div class="text-xs text-slate-400 font-medium uppercase mb-1">Coffee</div>
                        <div class="text-3xl font-bold font-mono text-slate-800 leading-none"><span id="coffee-val">20</span><span class="text-base text-slate-400 ml-1">g</span></div>
                    </div>
                    <button onclick="adjustCoffee(1)" class="w-8 h-8 rounded-full border border-slate-200 text-slate-600 flex items-center justify-center active:bg-slate-50">
                        <i class="fa-solid fa-plus text-xs"></i>
                    </button>
                </div>
                
                <div class="h-10 w-px bg-slate-100 mx-2"></div>

                <div class="text-right">
                    <div class="text-xs text-slate-400 font-medium uppercase mb-1">Water</div>
                    <div class="text-3xl font-bold font-mono text-indigo-600 leading-none" id="water-val">300</div>
                </div>
            </div>

            <!-- Ratio Slider -->
            <div class="pt-2">
                <div class="flex justify-between text-xs text-slate-400 mb-2 font-mono">
                    <span>STRONG (1:10)</span>
                    <span class="text-slate-800 font-bold">1:<span id="ratio-val">15</span></span>
                    <span>TEA-LIKE (1:20)</span>
                </div>
                <input type="range" id="ratio-slider" min="10" max="20" step="0.5" value="15" oninput="updateCalc()">
            </div>
        </section>

        <!-- 3. Recipe Selector -->
        <section>
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-3">Brewing Method</h2>
            <div id="recipe-list" class="space-y-3">
                <!-- Generated by JS -->
            </div>
        </section>

        <div class="h-8"></div> <!-- Spacer -->
    </main>
    
    <!-- Floating Start Button -->
    <div id="start-btn-container" class="fixed bottom-0 left-0 w-full p-5 glass-panel z-30">
        <button onclick="startBrewing()" class="w-full btn-primary h-14 rounded-2xl text-lg font-semibold shadow-xl shadow-slate-200 flex items-center justify-center gap-3 max-w-lg mx-auto">
            <span>Start Brewing</span>
            <i class="fa-solid fa-arrow-right"></i>
        </button>
    </div>

    <!-- BREWING SCREEN -->
    <main id="brewing-screen" class="hidden flex-col h-full w-full max-w-lg mx-auto bg-white relative">
        
        <!-- Brewing Top Bar -->
        <div class="flex-none flex justify-between items-center px-5 py-3 border-b border-slate-50 bg-white z-10">
            <button onclick="stopBrewing()" class="text-slate-400 hover:text-red-500 text-sm font-medium transition flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-slate-50">
                <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <div class="flex gap-2">
                <button onclick="toggleWakeLock()" id="wakelock-btn" class="text-slate-300 p-2 rounded-full hover:bg-slate-50 transition">
                    <i class="fa-solid fa-sun"></i>
                </button>
                <button onclick="toggleSound()" id="sound-btn" class="text-slate-600 p-2 rounded-full hover:bg-slate-50 transition">
                    <i class="fa-solid fa-volume-high"></i>
                </button>
            </div>
        </div>

        <!-- Timer Visual -->
        <div class="flex-1 flex flex-col items-center justify-center relative min-h-[300px]">
            <!-- Progress Ring -->
            <div class="relative w-64 h-64 flex items-center justify-center">
                <svg class="w-full h-full transform -rotate-90 drop-shadow-xl">
                    <circle cx="128" cy="128" r="120" stroke="#F3F4F6" stroke-width="6" fill="transparent" />
                    <circle id="timer-circle" cx="128" cy="128" r="120" stroke="#1F2937" stroke-width="6" fill="transparent" stroke-dasharray="754" stroke-dashoffset="0" stroke-linecap="round" class="transition-all duration-1000" />
                </svg>
                
                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <span id="step-label" class="text-xs font-bold text-indigo-500 uppercase tracking-widest mb-2 bg-indigo-50 px-2 py-1 rounded">Blooming</span>
                    <span id="main-timer" class="text-6xl font-bold text-slate-800 font-mono tracking-tighter">00:00</span>
                    <div class="mt-2 text-slate-400 text-sm font-medium flex items-center gap-2">
                        <span>Target:</span>
                        <span id="step-target-display" class="text-slate-800 font-bold text-lg">40ml</span>
                    </div>
                </div>
            </div>

            <!-- Instruction -->
            <div class="mt-8 text-center px-8 w-full animate-fade-in">
                <p id="step-instruction" class="text-slate-500 text-lg font-medium leading-relaxed">เทน้ำร้อนให้ทั่วผงกาแฟ</p>
            </div>
        </div>

        <!-- Controls (Bottom Sheet) -->
        <div class="flex-none bg-slate-50 border-t border-slate-100 p-6 pb-8 rounded-t-3xl shadow-[0_-4px_20px_rgba(0,0,0,0.03)] z-20">
            
            <!-- Control Buttons -->
            <div class="flex items-center justify-center gap-6 mb-6">
                <button onclick="togglePause()" id="pause-btn" class="w-16 h-16 rounded-2xl bg-white border border-slate-100 text-slate-800 shadow-sm flex items-center justify-center text-2xl active:scale-95 transition hover:shadow-md">
                    <i class="fa-solid fa-pause"></i>
                </button>
                <button onclick="skipStep()" class="w-16 h-16 rounded-2xl bg-slate-900 text-white shadow-lg shadow-slate-300 flex items-center justify-center text-2xl active:scale-95 transition hover:bg-slate-800">
                    <i class="fa-solid fa-forward-step"></i>
                </button>
            </div>

            <!-- Mini Timeline -->
            <div class="relative">
                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3 flex justify-between">
                    <span>Timeline</span>
                    <i class="fa-solid fa-chevron-up text-slate-300"></i>
                </div>
                <div id="timeline-container" class="h-28 overflow-y-auto no-scrollbar space-y-2 pr-1 relative mask-linear-fade">
                    <!-- Timeline Items -->
                </div>
                <!-- Fade overlay for list -->
                <div class="absolute bottom-0 left-0 w-full h-6 bg-gradient-to-t from-slate-50 to-transparent pointer-events-none"></div>
            </div>
        </div>
    </main>

    <!-- SUCCESS MODAL -->
    <div id="finish-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden items-center justify-center z-50 px-6 opacity-0 transition-opacity duration-300">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-xs w-full text-center transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-inner">
                <i class="fa-solid fa-check"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Brew Perfect!</h2>
            <p class="text-slate-500 mb-8 text-sm">กาแฟของคุณพร้อมเสิร์ฟแล้ว</p>
            
            <div class="flex justify-center gap-8 mb-8 border-t border-b border-slate-50 py-4">
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-wide">Time</div>
                    <div id="final-time" class="text-xl font-bold text-slate-700 font-mono">03:00</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-400 uppercase tracking-wide">Yield</div>
                    <div id="final-water" class="text-xl font-bold text-slate-700 font-mono">300ml</div>
                </div>
            </div>

            <button onclick="closeModal()" class="w-full btn-primary py-3.5 rounded-xl font-semibold shadow-lg text-sm">
                Enjoy Coffee
            </button>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONFIGURATION & DATA ---
        const CONFIG = {
            coffee: 20,
            ratio: 15,
            equipment: 'v60',
            recipe: 'v60_standard',
            sound: true
        };

        const EQUIPMENT = {
            v60: { name: 'Hario V60', icon: 'fa-filter', tip: 'Medium-Fine Grind' },
            kalita: { name: 'Kalita Wave', icon: 'fa-layer-group', tip: 'Medium Grind' },
            origami: { name: 'Origami', icon: 'fa-star-of-life', tip: 'Medium-Fine Grind' },
            chemex: { name: 'Chemex', icon: 'fa-flask', tip: 'Coarse Grind' }
        };

        const RECIPES = {
            v60_standard: {
                name: "Standard Balanced",
                desc: "Sweetness & Acidity Balance",
                equipment: ['v60', 'origami'],
                steps: (c, t) => [
                    { name: "Blooming", water: c*2, time: 45, type: 'pour', text: "Pour gently to saturate grounds" },
                    { name: "1st Pour (60%)", water: Math.round(t*0.6), time: 45, type: 'pour', text: "Pour in slow circular motion" },
                    { name: "2nd Pour (100%)", water: t, time: 45, type: 'pour', text: "Pour center to edge" },
                    { name: "Draw Down", water: t, time: 45, type: 'wait', text: "Wait for full drawdown" }
                ]
            },
            v60_tetsu: {
                name: "Tetsu 4:6 Method",
                desc: "World Champion Recipe",
                equipment: ['v60', 'origami'],
                steps: (c, t) => {
                    const p = Math.round(t/5);
                    return [
                        { name: "Acidity Phase", water: p, time: 45, type: 'pour', text: "Defines acidity level" },
                        { name: "Sweetness Phase", water: p*2, time: 45, type: 'pour', text: "Balances with sweetness" },
                        { name: "Strength 1", water: p*3, time: 45, type: 'pour', text: "Builds body" },
                        { name: "Strength 2", water: p*4, time: 45, type: 'pour', text: "Maintains strength" },
                        { name: "Finish", water: t, time: 45, type: 'pour', text: "Final pour" }
                    ];
                }
            },
            v60_hoffmann: {
                name: "Ultimate V60",
                desc: "High Extraction & Evenness",
                equipment: ['v60'],
                steps: (c, t) => [
                    { name: "Bloom & Swirl", water: c*2, time: 45, type: 'pour', text: "Pour then swirl brewer" },
                    { name: "Pour to 60%", water: Math.round(t*0.6), time: 30, type: 'pour', text: "Fast pour to target" },
                    { name: "Pour to 100%", water: t, time: 30, type: 'pour', text: "Gentle pour" },
                    { name: "Stir & Swirl", water: t, time: 10, type: 'wait', text: "Stir gently then swirl" },
                    { name: "Draw Down", water: t, time: 65, type: 'wait', text: "Wait for drawdown" }
                ]
            },
            kalita_pulse: {
                name: "Pulse Pouring",
                desc: "Consistent Temperature",
                equipment: ['kalita'],
                steps: (c, t) => {
                    const bloom = 40;
                    const rem = t - bloom;
                    const pulse = Math.round(rem/3);
                    return [
                        { name: "Bloom", water: bloom, time: 30, type: 'pour', text: "Saturate evenly" },
                        { name: "Pulse 1", water: bloom+pulse, time: 45, type: 'pour', text: "Pour slowly" },
                        { name: "Pulse 2", water: bloom+pulse*2, time: 45, type: 'pour', text: "Maintain water level" },
                        { name: "Pulse 3", water: t, time: 45, type: 'pour', text: "Final pour" },
                        { name: "Drain", water: t, time: 30, type: 'wait', text: "Let it drain" }
                    ];
                }
            },
            chemex_classic: {
                name: "Chemex Classic",
                desc: "Clean & Tea-like Body",
                equipment: ['chemex'],
                steps: (c, t) => [
                    { name: "Heavy Bloom", water: c*3, time: 45, type: 'pour', text: "Stir bloom if needed" },
                    { name: "Center Pour", water: Math.round(t*0.5), time: 60, type: 'pour', text: "Pour in center" },
                    { name: "Fill Up", water: t, time: 60, type: 'pour', text: "Fill to target weight" },
                    { name: "Long Drain", water: t, time: 60, type: 'wait', text: "Patience is key" }
                ]
            }
        };

        // --- STATE MANAGEMENT ---
        let session = {
            active: false,
            paused: false,
            time: 0,
            interval: null,
            stepIdx: 0,
            steps: [],
            totalWater: 300,
            wakeLock: null
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- INITIALIZATION ---
        function init() {
            renderEquipment();
            updateCalc();
        }

        // --- RENDERERS ---
        function renderEquipment() {
            const container = document.querySelector('#setup-screen section:first-child .grid');
            container.innerHTML = '';
            
            Object.entries(EQUIPMENT).forEach(([key, eq]) => {
                const isActive = CONFIG.equipment === key;
                const div = document.createElement('button');
                div.className = `p-3 rounded-xl border flex flex-col items-center gap-2 transition-all duration-200 ${isActive ? 'border-slate-800 bg-slate-800 text-white shadow-md transform scale-105' : 'border-slate-100 bg-white text-slate-400 hover:border-slate-300'}`;
                div.onclick = () => setEquipment(key);
                div.innerHTML = `
                    <i class="fa-solid ${eq.icon} text-xl mb-1"></i>
                    <span class="text-[10px] font-bold uppercase tracking-wide">${eq.name}</span>
                `;
                container.appendChild(div);
            });
            document.getElementById('grind-badge').innerText = `Grind: ${EQUIPMENT[CONFIG.equipment].tip}`;
            renderRecipes();
        }

        function renderRecipes() {
            const list = document.getElementById('recipe-list');
            list.innerHTML = '';
            
            let available = Object.entries(RECIPES).filter(([_, r]) => r.equipment.includes(CONFIG.equipment));
            
            // Auto-select logic if current recipe invalid
            if (!available.find(r => r[0] === CONFIG.recipe)) {
                CONFIG.recipe = available[0][0];
            }

            available.forEach(([key, r]) => {
                const isActive = CONFIG.recipe === key;
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl border cursor-pointer transition-all flex justify-between items-center ${isActive ? 'bg-indigo-50 border-indigo-200 shadow-sm' : 'bg-white border-slate-100 hover:border-slate-200'}`;
                div.onclick = () => { CONFIG.recipe = key; renderRecipes(); };
                div.innerHTML = `
                    <div>
                        <h3 class="font-bold text-sm ${isActive ? 'text-indigo-900' : 'text-slate-700'}">${r.name}</h3>
                        <p class="text-xs ${isActive ? 'text-indigo-600' : 'text-slate-400'}">${r.desc}</p>
                    </div>
                    ${isActive ? '<i class="fa-solid fa-check-circle text-indigo-600 text-lg"></i>' : ''}
                `;
                list.appendChild(div);
            });
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            
            session.steps.forEach((s, i) => {
                let stateClass = 'opacity-40'; // Future
                let icon = 'fa-circle';
                
                if (i === session.stepIdx) {
                    stateClass = 'opacity-100 font-bold bg-white shadow-sm border-slate-100'; // Current
                    icon = 'fa-play text-indigo-500 text-[10px]';
                } else if (i < session.stepIdx) {
                    stateClass = 'opacity-50 line-through'; // Past
                    icon = 'fa-check text-green-500';
                }

                const div = document.createElement('div');
                div.id = `tl-item-${i}`;
                div.className = `flex items-center gap-3 p-2 rounded-lg border border-transparent transition-all ${stateClass}`;
                div.innerHTML = `
                    <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center flex-none">
                        <i class="fa-solid ${icon} text-xs text-slate-400"></i>
                    </div>
                    <div class="flex-1 flex justify-between items-center">
                        <span class="text-xs text-slate-700">${s.name}</span>
                        <div class="text-right">
                            <div class="text-[10px] font-mono text-slate-500">${s.water}ml</div>
                            <div class="text-[10px] text-slate-300 font-mono">${s.time}s</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // --- ACTIONS ---
        function setEquipment(key) {
            CONFIG.equipment = key;
            renderEquipment();
        }

        function adjustCoffee(delta) {
            let newVal = CONFIG.coffee + delta;
            if (newVal < 10) newVal = 10;
            CONFIG.coffee = newVal;
            document.getElementById('coffee-val').innerText = newVal;
            updateCalc();
        }

        function updateCalc() {
            CONFIG.ratio = document.getElementById('ratio-slider').value;
            document.getElementById('ratio-val').innerText = CONFIG.ratio;
            
            session.totalWater = Math.ceil(CONFIG.coffee * CONFIG.ratio);
            document.getElementById('water-val').innerText = session.totalWater;
        }

        // --- BREWING CORE ---
        async function startBrewing() {
            // Wake Lock
            try {
                if ('wakeLock' in navigator) {
                    session.wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log('Wake Lock error', err); }

            // Logic
            const r = RECIPES[CONFIG.recipe];
            session.steps = r.steps(CONFIG.coffee, session.totalWater);
            session.stepIdx = 0;
            session.time = 0;
            session.active = true;
            session.paused = false;

            // UI Transition
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('start-btn-container').classList.add('hidden');
            document.getElementById('brewing-screen').classList.remove('hidden');
            document.getElementById('brewing-screen').classList.add('flex');
            
            // Audio Init (for mobile browser policy)
            if (audioCtx.state === 'suspended') audioCtx.resume();

            updateStepUI();
            renderTimeline();
            
            if (session.interval) clearInterval(session.interval);
            session.interval = setInterval(tick, 1000);
        }

        function tick() {
            if (session.paused) return;

            session.time++;
            document.getElementById('main-timer').innerText = formatTime(session.time);

            // Calc Step Logic
            let accumulatedTime = 0;
            for(let i=0; i < session.stepIdx; i++) accumulatedTime += session.steps[i].time;
            
            const currentStep = session.steps[session.stepIdx];
            const timeInStep = session.time - accumulatedTime;
            const remaining = currentStep.time - timeInStep;

            // Circle Animation (Global Progress)
            const totalDuration = session.steps.reduce((acc, s) => acc + s.time, 0);
            const percent = Math.min(session.time / totalDuration, 1);
            document.getElementById('timer-circle').style.strokeDashoffset = 754 - (754 * percent);

            if (timeInStep >= currentStep.time) {
                nextStep();
            }
        }

        function nextStep() {
            if (session.stepIdx < session.steps.length - 1) {
                session.stepIdx++;
                playSound('step');
                hapticFeedback();
                updateStepUI();
                renderTimeline();
                // Auto Scroll Timeline
                document.getElementById(`tl-item-${session.stepIdx}`).scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                finishBrewing();
            }
        }

        function updateStepUI() {
            const s = session.steps[session.stepIdx];
            
            // Fade effect
            const title = document.getElementById('step-label');
            const target = document.getElementById('step-target-display');
            const instruc = document.getElementById('step-instruction');
            
            title.style.opacity = 0;
            instruc.style.opacity = 0;
            
            setTimeout(() => {
                title.innerText = s.name;
                title.className = `text-xs font-bold uppercase tracking-widest mb-2 px-2 py-1 rounded ${s.type === 'wait' ? 'text-amber-600 bg-amber-50' : 'text-indigo-600 bg-indigo-50'}`;
                
                target.innerText = `${s.water}ml`;
                
                // Add Icon to instruction
                const icon = s.type === 'wait' ? '<i class="fa-solid fa-hourglass-half mr-2"></i>' : '<i class="fa-solid fa-fill-drip mr-2"></i>';
                instruc.innerHTML = icon + s.text;
                
                title.style.opacity = 1;
                instruc.style.opacity = 1;
            }, 150);
        }

        function finishBrewing() {
            clearInterval(session.interval);
            playSound('finish');
            hapticFeedback(200);
            
            // Release Wake Lock
            if (session.wakeLock) session.wakeLock.release();

            const modal = document.getElementById('finish-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Allow layout render then fade in
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                document.getElementById('modal-content').classList.remove('scale-95');
                document.getElementById('modal-content').classList.add('scale-100');
            }, 10);
            
            document.getElementById('final-time').innerText = formatTime(session.time);
            document.getElementById('final-water').innerText = `${session.totalWater}ml`;
        }

        // --- UTILS ---
        function togglePause() {
            session.paused = !session.paused;
            const btn = document.getElementById('pause-btn');
            btn.innerHTML = session.paused ? '<i class="fa-solid fa-play"></i>' : '<i class="fa-solid fa-pause"></i>';
            btn.classList.toggle('bg-amber-50');
            btn.classList.toggle('text-amber-600');
        }

        function skipStep() {
            let targetTime = 0;
            for(let i=0; i<=session.stepIdx; i++) targetTime += session.steps[i].time;
            session.time = targetTime;
            nextStep();
        }

        function stopBrewing() {
            if(confirm("Stop brewing?")) {
                clearInterval(session.interval);
                resetApp();
            }
        }

        function resetApp() {
            window.location.reload();
        }
        
        function closeModal() {
            resetApp();
        }

        function formatTime(s) {
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sec = (s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }

        // --- AUDIO & HAPTIC ---
        function toggleSound() {
            CONFIG.sound = !CONFIG.sound;
            const btn = document.getElementById('sound-btn');
            btn.innerHTML = CONFIG.sound ? '<i class="fa-solid fa-volume-high"></i>' : '<i class="fa-solid fa-volume-xmark text-slate-300"></i>';
        }

        function playSound(type) {
            if (!CONFIG.sound) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'step') {
                // Pleasant chime
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, now);
                osc.frequency.exponentialRampToValueAtTime(1046.5, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'finish') {
                // Major chord
                [523.25, 659.25, 783.99].forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.1, now);
                    g.gain.exponentialRampToValueAtTime(0.001, now + 2);
                    o.start(now + i*0.1);
                    o.stop(now + 2 + i*0.1);
                });
            }
        }

        function hapticFeedback(ms = 50) {
            if (navigator.vibrate) navigator.vibrate(ms);
        }

        function toggleWakeLock() {
            alert("Wake Lock is managed automatically when brewing starts.");
        }

        // Run
        init();
    </script>
</body>
</html>

